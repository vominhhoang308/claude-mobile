# Implementation Plan: Core Application

**Branch**: `001-core-application` | **Date**: 2026-02-20 | **Spec**: `specs/001-core-application/spec.md`
**Input**: Architecture discussion + implemented codebase (see conversation transcript)

---

## Summary

A monorepo mobile application that lets developers run Claude Code against their GitHub repositories from their phone. The architecture has three components: a React Native / Expo mobile app (UI only, no credentials), a stateless Cloudflare Workers relay (byte-forwarder, ~$0 cost), and a Node.js agent daemon that runs on a user-owned VPS or local machine and holds all credentials. The relay never sees secrets; the agent is the sole security boundary.

Claude authentication on the agent is user-selectable: **OAuth session** (default, zero-friction for developers who have already run `claude auth login`) or **API key** (required for headless VPS deployments).

---

## Technical Context

**Language/Version**: TypeScript 5.5 (`strict: true`); Node.js 20+ (agent); React Native 0.76 / Expo SDK 52 (mobile)
**Primary Dependencies**:
- _Agent_: `ws` 8.x, `@octokit/rest` 21.x, `simple-git` 3.x, `keytar` 7.x (optional), `uuid` 10.x
- _Relay_: Cloudflare Workers runtime, Durable Objects, `wrangler` 3.x
- _Mobile_: Expo 52, `@react-navigation/native` 6.x + `native-stack`, `expo-secure-store`, `expo-notifications`, `react-native-safe-area-context`

**Storage**: No server-side storage. Agent: OS keychain (`keytar`) → env var fallback. Mobile: `expo-secure-store` (sessionToken + relayUrl only).
**Testing**: Jest 29 + `ts-jest` (agent/relay unit); Jest 29 + `jest-expo` + React Native Testing Library 12 (mobile)
**Target Platform**: iOS 17+ and Android 10+ (mobile); Node.js 20+ on macOS/Linux (agent); Cloudflare Workers global edge (relay)
**Project Type**: Monorepo (`npm workspaces`) — 3 packages
**Performance Goals**: Streaming chunk latency < 100 ms; mobile JS thread never blocked > 16 ms; cold start < 2 s; 60 fps scrolling
**Constraints**: Relay stateless (no DB, no message storage); agent credentials never reach relay or mobile; `sessionToken` single-source-of-truth for routing
**Scale/Scope**: MVP — 1 agent per user, 1 relay deployment (Cloudflare), iOS-first

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Gate | Status | Notes |
|---|---|---|---|
| **I. Platform-Adaptive Design** | RN core components only; `SafeAreaView` everywhere; `FlatList` for all lists; HIG-compliant touch targets (≥44pt); dark/light mode via semantic tokens; `accessibilityLabel` on all interactive elements | ✅ PASS | All screens use `react-native-safe-area-context`; `FlatList` used in `RepositoryListScreen` and `ChatScreen`; theme tokens in `src/theme/index.ts`; every `TouchableOpacity` carries `accessibilityRole` + `accessibilityLabel` |
| **II. TypeScript-First** | `strict: true`; no `.js` in `src/`; `async/await` only; every new `npm` dep justified | ✅ PASS | All files `.ts`/`.tsx`; deps justified in `research.md`; constitution Complexity Tracking table below covers optional `keytar` |
| **III. API-Driven Intelligence** | No on-device AI; Claude API accessed only via `claude` CLI (agent-side); no API keys in mobile bundle | ✅ PASS | Mobile never holds `ANTHROPIC_API_KEY`; agent spawns `claude` CLI; relay is opaque |
| **IV. Privacy & App Store Compliance** | No secrets in `AsyncStorage`; `PrivacyInfo.xcprivacy` required; conversation content not persisted without consent | ✅ PASS | `expo-secure-store` used (not AsyncStorage); chat messages are in-memory only; `PrivacyInfo.xcprivacy` is a post-MVP task before App Store submission |
| **V. Test-Driven Development** | Tests written for every new module; coverage non-regression gate | ✅ PASS | `RelayClient.test.ts`, `ClaudeRunner.test.ts`, `ChatScreen.test.tsx`, `useWebSocket.test.ts` written; relay `AgentRegistry.test.ts` covers all pairing paths |
| **VI. Performance Standards** | FlatList for dynamic lists; Hermes enabled; no synchronous blocking; streaming not buffered | ✅ PASS | `FlatList` everywhere; Expo SDK 52 has Hermes on by default; `stream_chunk` events dispatched directly without batching |

---

## Project Structure

### Documentation (this feature)

```text
specs/001-core-application/
├── plan.md              ← this file
├── research.md          ← 11 architectural decisions with rationale
├── data-model.md        ← entity definitions (no DB — all in-memory or keychain)
├── quickstart.md        ← local dev setup + VPS deployment reference
├── contracts/
│   └── websocket-protocol.md   ← full message schema + lifecycle diagrams
└── tasks.md             ← generated by /speckit.tasks (not yet created)
```

### Source Code (repository root)

```text
/                                  ← repo root
├── package.json                   ← npm workspaces root
├── tsconfig.base.json             ← shared strict TS config
├── .eslintrc.js                   ← ESLint + @typescript-eslint
├── .prettierrc
├── .gitignore
│
├── apps/
│   └── mobile/                   ← React Native / Expo app
│       ├── App.tsx                ← entry: SafeAreaProvider → AgentProvider → RootNavigator
│       ├── app.json               ← Expo config (scheme, plugins, ios/android IDs)
│       ├── babel.config.js
│       ├── tsconfig.json
│       ├── jest.config.js
│       └── src/
│           ├── navigation/
│           │   └── RootNavigator.tsx       ← auth stack / app stack split on isConnected
│           ├── screens/
│           │   ├── OnboardingScreen.tsx    ← relay URL + 6-digit pairing code entry
│           │   ├── RepositoryListScreen.tsx
│           │   ├── ChatScreen.tsx          ← streaming chat + "Run autonomously" button
│           │   ├── TaskStatusScreen.tsx    ← live log + PR card on completion
│           │   └── SettingsScreen.tsx      ← status + disconnect
│           ├── hooks/
│           │   ├── useWebSocket.ts         ← low-level WS lifecycle
│           │   └── useAgentConnection.ts   ← pairing, chat, task, repos; persists token
│           ├── store/
│           │   └── agentStore.tsx          ← Context + useReducer (no external lib)
│           ├── theme/
│           │   └── index.ts               ← semantic color tokens, light/dark
│           ├── types/
│           │   └── protocol.ts            ← InboundMessage / OutboundMessage unions
│           └── __tests__/
│               ├── screens/ChatScreen.test.tsx
│               └── hooks/useWebSocket.test.ts
│
├── packages/
│   ├── agent/                    ← Node.js daemon (runs on user's VPS or laptop)
│   │   ├── package.json
│   │   ├── tsconfig.json
│   │   ├── jest.config.js
│   │   └── src/
│   │       ├── index.ts                   ← main entry; dispatch loop
│   │       ├── relay/
│   │       │   └── RelayClient.ts         ← persistent WS + auto-reconnect + heartbeat
│   │       ├── claude/
│   │       │   └── ClaudeRunner.ts        ← spawn `claude -p` / `--dangerously-skip-permissions`
│   │       ├── git/
│   │       │   └── GitManager.ts          ← clone/pull/branch/commit/push via simple-git
│   │       ├── github/
│   │       │   └── GitHubClient.ts        ← list repos, create PR via @octokit/rest
│   │       ├── secrets/
│   │       │   └── SecretsManager.ts      ← keytar → env var fallback; claudeAuthMethod
│   │       ├── setup/
│   │       │   └── setup.ts               ← interactive wizard; auth method choice
│   │       ├── types/
│   │       │   └── protocol.ts
│   │       └── __tests__/
│   │           ├── relay/RelayClient.test.ts
│   │           └── claude/ClaudeRunner.test.ts
│   │
│   └── relay/                    ← Cloudflare Worker (stateless WS proxy)
│       ├── package.json
│       ├── tsconfig.json
│       ├── wrangler.toml
│       └── src/
│           ├── index.ts                   ← Worker entry; routes WS to DO
│           ├── AgentRegistry.ts           ← Durable Object; pairing + forwarding logic
│           ├── types/
│           │   └── protocol.ts
│           └── __tests__/
│               └── relay.test.ts          ← DO state-machine tests (stub WebSocket)
│
└── specs/
    └── 001-core-application/      ← this directory
```

**Structure Decision**: Three-package monorepo. `apps/mobile` is the Expo app; `packages/agent` and `packages/relay` are the backend packages. Each package has its own `tsconfig.json` extending `tsconfig.base.json`. No cross-package build-time imports — protocol types are duplicated intentionally so each package deploys independently.

---

## Architecture Decisions

### Claude authentication (agent)

```
Setup wizard (first run):
  ? How should the agent authenticate with Claude?
    [1] Use existing OAuth session (default)   ← zero config for devs with claude auth login
    [2] Use API key                             ← required on headless VPS

If [1]: claudeAuthMethod = 'oauth' stored; API key prompt skipped entirely
If [2]: claudeAuthMethod = 'apikey' stored; API key prompted + stored in keychain

index.ts at runtime:
  if (claudeAuthMethod === 'apikey') process.env.ANTHROPIC_API_KEY = key
  else: claude CLI inherits existing ~/.claude/ OAuth session
```

### Relay routing model

```
agentToken (UUID)    — identifies an agent; known only to agent + relay
pairingCode (6-digit) — short-lived; single-use; bridges agent ↔ mobile at pairing time
sessionToken (UUID)  — issued by relay after successful pairing; stored in mobile SecureStore
sessionId            — equals sessionToken; stamped on every forwarded message for routing
```

### Claude Code invocation

| Mode | Command | When |
|---|---|---|
| Chat (interactive) | `claude -p "<prompt>"` | `chat_message` from mobile |
| Autonomous (task) | `claude --dangerously-skip-permissions -p "<prompt>"` | `task_start` from mobile |

`stdout` and `stderr` are both forwarded as `stream_chunk` messages in real time.

### Autonomous task flow

```
1. Create branch:  claude-mobile/<slug>-<timestamp>
2. Run claude --dangerously-skip-permissions -p "<context>"
3. git add . && git commit
4. git push --set-upstream origin <branch>
5. POST /repos/{owner}/{repo}/pulls  (via Octokit)
6. Send task_done { prUrl, prTitle } to mobile
7. Mobile fires local push notification via expo-notifications
```

---

## Complexity Tracking

> Violations of constitution simplicity rules that are justified by the MVP requirements.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|---|---|---|
| 3 packages instead of 1 | Relay (Cloudflare Workers), agent (Node.js), mobile (React Native) are three fundamentally different deployment targets with different runtimes | Cannot bundle a Cloudflare Worker and a React Native app in a single package; separation is mandatory |
| `keytar` optional dependency | OS keychain is the only acceptable secrets store on a developer laptop; plain `.env` files prohibited | Hardcoding secrets in env files violates Principle III/IV; plain files on disk are a security regression |
| Protocol types duplicated across 3 packages | Each package deploys independently (CF Worker, npm binary, Expo app); cross-package imports at build time would couple their deployment pipelines | A shared `@claude-mobile/protocol` package would require consumers to depend on it at install time, complicating independent deploys and adding a fourth package |
| `expo-secure-store` instead of `react-native-keychain` | Constitution lists `react-native-keychain` but `expo-secure-store` is the Expo-managed equivalent, avoiding a bare-workflow ejection | `react-native-keychain` requires native linking that conflicts with Expo managed workflow; constitution has TODO(EXPO_VS_BARE) unresolved |
